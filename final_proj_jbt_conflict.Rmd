---
title: "Graphs of Opioid Deaths"
author: "Julia Thompson"
date: "11/30/2019"
output: html_document
---

## ER visits by county & distance to treatment facility

Is there any relationship between number of ER visits and distance to treatment facility?

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(arcos)
library(readxl)
library(plotly)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r load datasets, include=FALSE}
opioid_death_data = janitor::clean_names(read_csv('./opioid_related_deaths.csv'))

county_pop = janitor::clean_names(read_excel("./data/county_pop.xlsx"))

opioid_treatment_distance = janitor::clean_names(read_csv('./distance_to_treatment.csv'))
```

Because distance to nearest treatment facility data is from 2017, look at opioid deaths in just 2017.

```{r, include=FALSE}
# clean opioid death data #

opioid_death = opioid_death_data %>% 
  filter(year == 2017) %>% 
  select(-year)

county_pop = 
  county_pop %>% 
  mutate(
    county = str_replace(county, " County", "")
  )

opioid_treatment_dist = 
  opioid_treatment_distance %>% 
  rename(distance = value) %>% 
  filter(state == 'New York') %>%
  select(county, distance)

# get rid of "county" in opioid_treatment_distance

opioid_treatment_dist = 
  opioid_treatment_dist %>% 
  mutate(
    county = str_replace(county, " County", "")
  )

treatment_death = 
  left_join(opioid_treatment_dist, opioid_death, by = "county")

treatment_death_final = 
  left_join(treatment_death, county_pop, by = "county") %>% 
  select(-rank) %>% 
  mutate(
    deaths_rate = (opioid_poisoning_deaths / population)*100
  )
```

any relationship between rate and distance? Nope... the shorter the distance, the more deaths. Looking at rate, there is no real pattern? Kinda interesting that there's no relationship I guess.

```{r, include=FALSE}
ggplot(treatment_death_final, aes(x = distance, y = opioid_poisoning_deaths))+
  geom_point()

ggplot(treatment_death_final, aes(x = distance, y = deaths_rate))+
  geom_point()
```

```{r, include=FALSE}
take_back = read_csv("./data/take_back.csv") %>% 
  janitor::clean_names() %>% 
  select(county) %>% 
  group_by(county) %>% 
  summarize(
    takeback_facilities = n()
  )
```

```{r, include=FALSE}
treatment_death_final = treatment_death_final %>% 
  left_join(take_back, treatment_death_final, by = "county")

treatment_death_final = treatment_death_final %>% 
  mutate(
    takeback_facilities = replace_na(takeback_facilities, 0)
  )



ggplot(treatment_death_final, aes(x = takeback_facilities, y = deaths_rate))+
  geom_point()
```

We plot the distance to the closest treatment facility in each county vs the number of takeback facilities in that county. We find that counties that are closer to treatment facilities also tend to have more takeback facilities. 

```{r, message = FALSE, echo = FALSE}
ggplot(treatment_death_final, aes(x = distance, y = takeback_facilities))+
  geom_point()
```

## Look at demographic data

```{r, include=FALSE}
deaths_age_grp = read_csv("./data/deaths_age_group.csv") %>% 
  janitor::clean_names() %>% 
  pivot_wider(
    names_from = age_group,
    values_from = opioid_poisoning_deaths
  ) %>% 
  janitor::clean_names()
```

```{r, include=FALSE}
deaths_by_year = deaths_age_grp %>% 
  select(year, region, race_or_ethnicity, sex, total) %>% 
  group_by(year, race_or_ethnicity) %>% 
  summarize(
    count = sum(total)
  ) %>% 
  mutate(
    race_or_ethnicity = factor(race_or_ethnicity, levels = c("Not Stated", "Other Non Hispanic", "Black Non Hispanic", "Hispanic", "White Non Hispanic"))
  )

ggplot(deaths_by_year, aes(x = year, y = count, fill = race_or_ethnicity)) +
  geom_bar(stat = "identity", position="dodge")
```

Count of deaths by race from 2003 to 2017:

```{r, message = FALSE, echo = FALSE}
deaths_by_year %>% 
  plot_ly(x = ~year, y = ~count, type = "bar",
    color = ~race_or_ethnicity, alpha = 0.5)
```

```{r, include=FALSE}
deaths_by_age = read_csv("./data/deaths_age_group.csv") %>% 
  janitor::clean_names() %>% 
  select(-region, -race_or_ethnicity, -sex) %>% 
  filter(age_group != "Total") %>% 
  group_by(year, age_group) %>% 
  summarize(
    count = sum(opioid_poisoning_deaths)
  ) %>% 
  ungroup()

ggplot(deaths_by_age, aes(x = year, y = count, fill = age_group)) +
  geom_bar(stat = "identity", position="dodge")

ggplot(deaths_by_age, aes(x = year, y = count, color = age_group)) +
  geom_point() +
  geom_line()
```

Count of deaths by age group from 2003 to 2017:

```{r, message = FALSE, echo = FALSE}
deaths_by_age %>% 
  plot_ly(x = ~year, y = ~count, type = "scatter", mode = "lines+markers",
    color = ~factor(age_group), alpha = 0.5)
```






